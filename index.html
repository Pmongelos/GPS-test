<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>To Moko - Estado de Sincronización</title>
    <style>
        :root {
            --bg: #0d1117;
            --card: #161b22;
            --border: #30363d;
            --primary: #4f46e5;
            --text: #c9d1d9;
            --text-dim: #8b949e;
            --st-sync: #38bdf8; /* Azul */
            --st-ready: #4ade80; /* Verde */
            --st-fail: #fb923c;  /* Naranja */
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: -apple-system, system-ui, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            display: flex;
            justify-content: center;
            min-height: 100vh;
            padding: 15px;
        }

        .container {
            background-color: var(--card);
            border: 1px solid var(--border);
            border-radius: 24px;
            width: 100%;
            max-width: 400px;
            padding: 24px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.7);
            align-self: center;
        }

        /* Badge de Estado Dinámico */
        .status-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .badge {
            font-size: 10px;
            font-weight: 800;
            padding: 6px 12px;
            border-radius: 20px;
            text-transform: uppercase;
            border: 1px solid transparent;
            transition: all 0.4s ease;
        }
        .st-sync { background: rgba(56, 189, 248, 0.1); color: var(--st-sync); border-color: rgba(56, 189, 248, 0.3); }
        .st-ready { background: rgba(74, 222, 128, 0.1); color: var(--st-ready); border-color: rgba(74, 222, 128, 0.3); }
        .st-fail { background: rgba(251, 146, 60, 0.1); color: var(--st-fail); border-color: rgba(251, 146, 60, 0.3); }

        /* Navegación */
        .tabs { display: flex; gap: 8px; margin-bottom: 24px; }
        .tab-btn {
            flex: 1;
            padding: 12px;
            background: #21262d;
            border: 1px solid var(--border);
            color: var(--text-dim);
            border-radius: 12px;
            font-weight: bold;
            font-size: 11px;
            cursor: pointer;
        }
        .tab-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* UI Principal */
        .btn { width: 100%; padding: 18px; border-radius: 14px; border: none; font-weight: 800; cursor: pointer; text-transform: uppercase; font-size: 12px; transition: 0.2s; }
        .btn-main { background: var(--primary); color: white; margin-bottom: 12px; }
        .btn-main:active { transform: scale(0.97); }

        .hidden { display: none !important; }

        /* Radar Animación */
        .radar-view { text-align: center; padding: 40px 0; }
        .radar-circle {
            width: 100px;
            height: 100px;
            border: 4px solid var(--primary);
            border-radius: 50%;
            margin: 0 auto 20px;
            position: relative;
        }
        .pulse {
            position: absolute;
            top: -4px; left: -4px; right: -4px; bottom: -4px;
            border: 4px solid var(--primary);
            border-radius: 50%;
            animation: pulse-ring 2s infinite;
        }
        @keyframes pulse-ring {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(1.8); opacity: 0; }
        }

        /* Colección */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .moko-thumb {
            background: #0d1117;
            padding: 12px;
            border-radius: 16px;
            border: 1px solid var(--border);
            text-align: center;
            cursor: pointer;
        }
        .moko-thumb img { width: 100%; height: 80px; object-fit: cover; border-radius: 10px; margin-bottom: 10px; }
        .moko-thumb span { font-size: 10px; font-weight: bold; color: var(--text); display: block; }
    </style>
</head>
<body>

    <div class="container">
        <div class="status-header">
            <div id="status-badge" class="badge st-sync">Sincronizando...</div>
            <div id="conn-type" style="font-size: 9px; font-weight: bold; color: #555;">[ RED: BUSCANDO ]</div>
        </div>

        <div class="tabs">
            <button id="nav-scan" class="tab-btn active">RADAR</button>
            <button id="nav-coll" class="tab-btn">COLECCIÓN (<span id="count">0</span>)</button>
        </div>

        <!-- VISTA RADAR -->
        <div id="view-scan">
            <div id="ui-controls">
                <div style="text-align: center; margin-bottom: 30px;">
                    <h1 style="margin: 0; font-style: italic; font-size: 32px; letter-spacing: -1px;">TO MOKO</h1>
                    <p style="font-size: 10px; color: var(--text-dim); letter-spacing: 4px; font-weight: bold;">OFFLINE TRACKER</p>
                </div>

                <div style="background: #010409; padding: 15px; border-radius: 16px; border: 1px solid var(--border); margin-bottom: 20px;">
                    <p style="font-size: 10px; font-weight: bold; margin-bottom: 10px; color: var(--primary);">MODO GPS</p>
                    <button id="btn-gps" class="btn btn-main">Escaneo Satelital</button>
                </div>

                <div style="background: #010409; padding: 15px; border-radius: 16px; border: 1px solid var(--border);">
                    <p style="font-size: 10px; font-weight: bold; margin-bottom: 10px; color: var(--text-dim);">MODO MANUAL</p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                        <input type="number" id="lat" placeholder="Lat" style="background: #161b22; border: 1px solid var(--border); color: white; padding: 12px; border-radius: 8px;">
                        <input type="number" id="lon" placeholder="Lon" style="background: #161b22; border: 1px solid var(--border); color: white; padding: 12px; border-radius: 8px;">
                    </div>
                    <button id="btn-man" class="btn" style="background: #21262d; color: white;">Comparar</button>
                </div>
            </div>

            <!-- Radar Loading -->
            <div id="ui-radar" class="radar-view hidden">
                <div class="radar-circle"><div class="pulse"></div></div>
                <p style="color: var(--st-sync); font-weight: 800; font-size: 12px; letter-spacing: 2px;">INTERCEPTANDO SEÑAL...</p>
            </div>

            <!-- Detalle -->
            <div id="ui-detail" class="hidden" style="margin-top: 20px; animation: fadeIn 0.5s;">
                <img id="m-img" style="width:100%; height:220px; object-fit:cover; border-radius: 16px; margin-bottom: 15px; border: 1px solid var(--border);">
                <h2 id="m-name" style="margin:0 0 10px 0; font-style: italic;"></h2>
                <p id="m-desc" style="font-size: 12px; color: var(--text-dim); line-height: 1.6;"></p>
            </div>
        </div>

        <!-- VISTA COLECCIÓN -->
        <div id="view-coll" class="hidden">
            <h2 style="font-style: italic; margin-bottom: 20px;">HALLAZGOS</h2>
            <div id="coll-grid" class="grid"></div>
            <p id="coll-empty" style="text-align: center; padding: 50px 0; color: #444; font-size: 12px;">Tu colección está vacía.</p>
        </div>
    </div>

    <script>
        // CONFIG
        const STATIONS = [
            { id: "1", name: "Urutengangana", img: "https://images.unsplash.com/photo-1518709268805-4e9042af9f23?w=400", desc: "Dios de la luz primordial y el conocimiento.", lat: -41.168, lon: 174.060 },
            { id: "2", name: "Tumatauenga", img: "https://images.unsplash.com/photo-1590424768411-9a742880194a?w=400", desc: "Deidad de la guerra y la supervivencia.", lat: -39.352, lon: 174.221 },
            { id: "3", name: "Rūaumoko", img: "https://images.unsplash.com/photo-1467385829985-2b0fb82b5193?w=400", desc: "El dios de los terremotos y volcanes.", lat: -42.111, lon: 172.601 }
        ];

        let unlocked = JSON.parse(localStorage.getItem('mokos_final') || '[]');
        
        // UI REFS
        const badge = document.getElementById('status-badge');
        const connText = document.getElementById('conn-type');
        const countDisplay = document.getElementById('count');

        // LÓGICA DE ESTADOS (PROCESO DE CARGA)
        let isFullyLoaded = false;

        function updateStatus(state) {
            badge.className = 'badge ' + state;
            if (state === 'st-sync') badge.textContent = 'Sincronizando...';
            if (state === 'st-ready') {
                badge.textContent = 'Listo (Offline)';
                isFullyLoaded = true;
            }
            if (state === 'st-fail') badge.textContent = 'Modo Híbrido';
        }

        // Simular timeout de fallo si el SW no responde
        const loadTimeout = setTimeout(() => {
            if (!isFullyLoaded) updateStatus('st-fail');
        }, 6000);

        // LÓGICA DE NEGOCIO
        async function startRadar(lat, lon) {
            document.getElementById('ui-controls').classList.add('hidden');
            document.getElementById('ui-detail').classList.add('hidden');
            document.getElementById('ui-radar').classList.remove('hidden');

            await new Promise(r => setTimeout(r, 2500));

            document.getElementById('ui-radar').classList.add('hidden');
            document.getElementById('ui-controls').classList.remove('hidden');

            // Cálculo distancia
            STATIONS.forEach(s => {
                const dLat = (s.lat - lat) * Math.PI/180;
                const dLon = (s.lon - lon) * Math.PI/180;
                const a = Math.sin(dLat/2)**2 + Math.cos(lat*Math.PI/180)*Math.cos(s.lat*Math.PI/180)*Math.sin(dLon/2)**2;
                s.dist = 6371 * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            });

            STATIONS.sort((a,b) => a.dist - b.dist);
            const win = STATIONS[0];

            if(win.dist < 0.1) {
                if(!unlocked.includes(win.id)) {
                    unlocked.push(win.id);
                    localStorage.setItem('mokos_final', JSON.stringify(unlocked));
                    countDisplay.textContent = unlocked.length;
                }
                renderMoko(win);
            }
        }

        function renderMoko(m) {
            document.getElementById('m-name').textContent = m.name;
            document.getElementById('m-img').src = m.img;
            document.getElementById('m-desc').textContent = m.desc;
            document.getElementById('ui-detail').classList.remove('hidden');
        }

        function renderCollection() {
            const grid = document.getElementById('coll-grid');
            const empty = document.getElementById('coll-empty');
            grid.innerHTML = '';
            if(unlocked.length === 0) { empty.classList.remove('hidden'); return; }
            empty.classList.add('hidden');
            unlocked.forEach(id => {
                const m = STATIONS.find(s => s.id === id);
                if(m) {
                    const d = document.createElement('div');
                    d.className = 'moko-thumb';
                    d.onclick = () => { document.getElementById('nav-scan').click(); renderMoko(m); };
                    d.innerHTML = `<img src="${m.img}"><span>${m.name.toUpperCase()}</span>`;
                    grid.appendChild(d);
                }
            });
        }

        // NAVEGACIÓN
        document.getElementById('nav-scan').onclick = () => {
            document.getElementById('view-scan').classList.remove('hidden');
            document.getElementById('view-coll').classList.add('hidden');
            document.getElementById('nav-scan').classList.add('active');
            document.getElementById('nav-coll').classList.remove('active');
        };
        document.getElementById('nav-coll').onclick = () => {
            document.getElementById('view-scan').classList.add('hidden');
            document.getElementById('view-coll').classList.remove('hidden');
            document.getElementById('nav-scan').classList.remove('active');
            document.getElementById('nav-coll').classList.add('active');
            renderCollection();
        };

        // BOTONES
        document.getElementById('btn-gps').onclick = () => {
            navigator.geolocation.getCurrentPosition(p => startRadar(p.coords.latitude, p.coords.longitude));
        };
        document.getElementById('btn-man').onclick = () => {
            const la = parseFloat(document.getElementById('lat').value);
            const lo = parseFloat(document.getElementById('lon').value);
            if(!isNaN(la)) startRadar(la, lo);
        };

        // SERVICE WORKER & COMUNICACIÓN
        if ('serviceWorker' in navigator) {
            const swCode = `
                const CACHE_NAME = 'moko-v9';
                const ASSETS = ['./', './index.html'];

                self.addEventListener('install', e => {
                    e.waitUntil(
                        caches.open(CACHE_NAME).then(cache => {
                            return cache.addAll(ASSETS).then(() => {
                                // Informamos a la pestaña que todo se cargó
                                self.skipWaiting();
                            });
                        })
                    );
                });

                self.addEventListener('activate', e => {
                    e.waitUntil(clients.claim().then(() => {
                        return self.clients.matchAll().then(all => {
                            all.forEach(client => client.postMessage({type: 'LOAD_COMPLETE'}));
                        });
                    }));
                });

                self.addEventListener('fetch', e => {
                    e.respondWith(caches.match(e.request).then(res => res || fetch(e.request)));
                });
            `;
            
            const blob = new Blob([swCode], {type: 'text/javascript'});
            navigator.serviceWorker.register(URL.createObjectURL(blob));

            navigator.serviceWorker.addEventListener('message', (event) => {
                if (event.data.type === 'LOAD_COMPLETE') {
                    updateStatus('st-ready');
                    clearTimeout(loadTimeout);
                }
            });
        }

        // INIT
        window.onload = () => {
            countDisplay.textContent = unlocked.length;
            connText.textContent = navigator.onLine ? "[ RED: ONLINE ]" : "[ RED: OFFLINE ]";
        };
        window.ononline = () => connText.textContent = "[ RED: ONLINE ]";
        window.onoffline = () => connText.textContent = "[ RED: OFFLINE ]";
    </script>
</body>
</html>

